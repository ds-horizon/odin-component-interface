# TEMPORARY: Test release workflow on feature branch
# DELETE THIS FILE BEFORE MERGING TO MAIN

name: Test Release Flow

on:
  # Add push trigger to make it visible in Actions tab
  push:
    branches:
      - feat/oss
    paths:
      - '.github/workflows/release-test.yml'

  # Keep workflow_dispatch for manual testing
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to simulate (e.g., v1.0.0)'
        required: true
        default: 'v0.0.1'

env:
  ARTIFACT_NAME: odin-component-interface

jobs:
  test-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: 3.8.2

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Simulate version extraction
        id: get_version
        run: |
          # For testing, use input or default
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            releaseVersion="${{ github.event.inputs.tag_name }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            releaseVersion="v0.0.1"  # Default for push trigger
          else
            releaseVersion="${GITHUB_REF/refs\/tags\//}"
          fi

          # Validate tag format
          if [[ ! "$releaseVersion" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag must be in format vX.Y.Z (e.g., v1.0.0)"
            exit 1
          fi

          releaseVersion="${releaseVersion//v/}"
          echo "Testing with version : ${releaseVersion}"
          echo "VERSION=$releaseVersion" >> $GITHUB_OUTPUT

      - name: Test POM version check
        run: |
          currentVersion=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current POM version: $currentVersion"
          echo "Would expect: ${{ steps.get_version.outputs.VERSION }}-SNAPSHOT"

          # For testing, just warn instead of failing
          expectedVersion="${{ steps.get_version.outputs.VERSION }}-SNAPSHOT"
          if [[ "$currentVersion" != "$expectedVersion" ]]; then
            echo "TEST MODE: POM version mismatch detected but continuing..."
          fi

      - name: Build and Test
        run: |
          mvn clean verify --no-transfer-progress
          echo "Build successful!"
          ls -la target/*.jar

      - name: Simulate artifact upload
        run: |
          echo "TEST MODE: Would upload the following artifact:"
          ls -la target/${{ env.ARTIFACT_NAME }}-*-jar-with-dependencies.jar

          # Test the gh CLI command syntax (dry run)
          echo "Would run: gh release upload ${{ steps.get_version.outputs.VERSION }} ..."

      - name: Test version bump script
        run: |
          echo "TEST MODE: Would run bump-version.sh"
          echo "Current version: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"
          echo "Would bump to next SNAPSHOT"
          # Don't actually run it to avoid committing